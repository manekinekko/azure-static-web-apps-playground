<mat-drawer-container
  autosize
  appDragDrop
  (onFileDropped)="processConfigFile($event)"
>
  <mat-drawer #drawer mode="side" fixedInViewport="false">
    <section>
      <ngx-monaco-editor
        (init)="onEditorInit($event)"
        [options]="editorOptions"
        [ngModel]="swaConfigRules"
        (ngModelChange)="onSwaConfigRulesChanged($event)"
      >
      </ngx-monaco-editor>
    </section>
    <button
      class="toggle-code-editor"
      type="button"
      *ngIf="swaConfigRulesObject"
      mat-button
      (click)="drawer.toggle()"
    >
      Toggle code editor
    </button>
  </mat-drawer>

  <div class="content">
    <section class="upload-indicator" *ngIf="!swaConfigRulesObject">
      <p>
        <mat-icon>cloud_upload</mat-icon>
      </p>
      <p>Drag and drop your staticwebapp.config.json file here</p>
    </section>

    <section class="route-test-container" *ngIf="swaConfigRulesObject">
      <mat-form-field class="route-test-method">
        <mat-label>Method</mat-label>
        <mat-select
          [(ngModel)]="testMethod"
          (selectionChange)="onMethodInputChange($event)"
          aria-label="Test HTTP method"
        >
          <mat-option value="GET">GET</mat-option>
          <mat-option value="HEAD">HEAD</mat-option>
          <mat-option value="POST">POST</mat-option>
          <mat-option value="PUT">PUT</mat-option>
          <mat-option value="DELETE">DELETE</mat-option>
          <mat-option value="CONNECT">CONNECT</mat-option>
          <mat-option value="OPTIONS">OPTIONS</mat-option>
          <mat-option value="TRACE">TRACE</mat-option>
          <mat-option value="PATCH">PATCH</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="route-test-roles">
        <mat-label>Roles</mat-label>
        <mat-chip-list #chipList aria-label="Roles selection">
          <mat-chip
            *ngFor="let role of testRoles"
            [removable]="true"
            [selected]="role === 'anonymous' || role === 'authenticated'"
            [color]="
              role === 'anonymous' || role === 'authenticated'
                ? 'accent'
                : 'primary'
            "
            (removed)="removeRole(role)"
          >
            {{ role }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <input
            placeholder="Role..."
            [matChipInputFor]="chipList"
            [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
            [matChipInputAddOnBlur]="true"
            (matChipInputTokenEnd)="addRole($event)"
          />
        </mat-chip-list>
      </mat-form-field>
      <mat-form-field class="route-test-route">
        <mat-label>Route</mat-label>
        <input
          autocomplete="off"
          placeholder="Route..."
          aria-label="Test route"
          matInput
          type="text"
          (input)="onRouteInputChange(testRoute)"
          [(ngModel)]="testRoute"
        />
        <button
          mat-button
          *ngIf="testRoute"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="clearTestRoute()"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </section>

    <section class="routes-inspector" *ngIf="swaConfigRulesObject">
      <mat-accordion multi>
        <mat-expansion-panel
          *ngIf="swaConfigRulesObject?.routes"
          #expansionPanelRouteRules
        >
          <mat-expansion-panel-header>
            <mat-panel-title>Routes</mat-panel-title>
            <mat-panel-description>
              Found {{ swaConfigRulesObject?.$$size?.routes }} route rules
              <mat-icon>rule</mat-icon>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <mat-list>
            <mat-list-item
              *ngFor="
                let route of swaConfigRulesObject?.routes;
                let last = last
              "
              [ngClass]="{
                'match-true': route.$$match === true,
                'match-false': route.$$match === false
              }"
              id="route-rule-{{ route.$$id }}"
            >
              <mat-icon mat-list-icon *ngIf="route.$$match === undefined"
                >tag</mat-icon
              >
              <mat-icon mat-list-icon *ngIf="route.$$match === true"
                >check</mat-icon
              >
              <mat-icon mat-list-icon *ngIf="route.$$match === false"
                >close</mat-icon
              >

              <div mat-line>{{ route.route }}</div>
              <div mat-line *ngIf="route.statusCode">
                Responde with code <b>{{ route.statusCode }}</b>
              </div>
              <div mat-line *ngIf="route.rewrite">
                Rewrite to <b>{{ route.rewrite }}</b>
              </div>
              <div mat-line *ngIf="route.redirect">
                Redirect to <b>{{ route.redirect }}</b>
              </div>
              <div mat-line *ngIf="route.headers">
                Add headers <br />
                <b *ngFor="let header of route.headers | keyvalue"
                  >&nbsp;&nbsp;{{ header.key }}: {{ header.value }}</b
                >
              </div>
              <div mat-line *ngIf="route.allowedRoles">
                Authorize for <b>{{ route.allowedRoles }}</b>
              </div>
              <div mat-line *ngIf="route.methods">
                Methods <b>{{ route.methods }}</b>
              </div>
              <mat-divider *ngIf="!last"></mat-divider>
            </mat-list-item>
          </mat-list>
        </mat-expansion-panel>

        <mat-expansion-panel *ngIf="swaConfigRulesObject?.navigationFallback">
          <mat-expansion-panel-header>
            <mat-panel-title>Fallback routes</mat-panel-title>
            <mat-panel-description>
              Fallback routes to&nbsp;
              {{ swaConfigRulesObject?.navigationFallback?.rewrite }}
              <mat-icon>mediation</mat-icon>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <p>
            Rewrite all routes to
            <b>{{ swaConfigRulesObject?.navigationFallback?.rewrite }}</b
            >.
          </p>
          <p *ngIf="swaConfigRulesObject?.navigationFallback?.exclude?.length">
            Except files that match
            <b>{{ swaConfigRulesObject?.navigationFallback?.exclude }}</b
            >.
          </p>
        </mat-expansion-panel>

        <mat-expansion-panel *ngIf="swaConfigRulesObject?.globalHeaders">
          <mat-expansion-panel-header>
            <mat-panel-title>Global headers</mat-panel-title>
            <mat-panel-description>
              Found {{ swaConfigRulesObject?.$$size?.globalHeaders }} headers
              <mat-icon>http</mat-icon>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <mat-list>
            <mat-list-item
              *ngFor="
                let header of swaConfigRulesObject?.globalHeaders | keyvalue
              "
            >
              <mat-icon mat-list-icon>keyboard_arrow_right</mat-icon>
              <div mat-line>
                <span>{{ header.key }}</span>
                &nbsp;<b>{{ header.value }}</b>
              </div>
            </mat-list-item>
          </mat-list>
        </mat-expansion-panel>

        <mat-expansion-panel *ngIf="swaConfigRulesObject?.responseOverrides">
          <mat-expansion-panel-header>
            <mat-panel-title>Response overrides</mat-panel-title>
            <mat-panel-description>
              Found
              {{ swaConfigRulesObject?.$$size?.responseOverrides }} overrides
              <mat-icon>swap_calls</mat-icon>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <mat-list>
            <mat-list-item
              *ngFor="
                let response of swaConfigRulesObject?.responseOverrides
                  | keyvalue
              "
            >
              <mat-icon mat-list-icon>keyboard_arrow_right</mat-icon>
              <div mat-line>{{ response.key }}</div>
              <div mat-line *ngIf="response.value.statusCode">
                Response Status Code <b>{{ response.value.statusCode }}</b>
              </div>
              <div mat-line *ngIf="response.value.rewrite">
                Rewrite to <b>{{ response.value.rewrite }}</b>
              </div>
              <div mat-line *ngIf="response.value.redirect">
                Redirect to <b>{{ response.value.redirect }}</b>
              </div>
            </mat-list-item>
          </mat-list>
        </mat-expansion-panel>
      </mat-accordion>
    </section>
  </div>
</mat-drawer-container>
